# Gemini Helper 会话管理与导出功能需求文档

> **文档版本**: v2.2 **最后更新**: 2025-12-19 (Phase 3 Completed) **状态**: Phase 3 完成，交互与标签系统设计中

---

## 1. 功能概述

本功能旨在为 Gemini Helper 添加一个独立的 **"会话" Tab**，解决以下用户痛点：

1. **对话过多难以定位**：历史对话列表过长，翻找成本高
2. **无法归类整理**：相关主题的对话无法"打包"或"归类"
3. **内容导出需求**：需要将对话导出为可存档、可阅读的格式

---

## 2. MVP 核心功能 (P0)

### 2.1 独立"会话" Tab

-   **Tab 名称**：`会话`（zh-CN）/ `會話`（zh-TW）/ `Conversations`（en）
-   **位置**：与现有 Prompts、Outline、Settings Tab 并列
-   **可配置**：
    -   在 `设置 → 界面排版` 中添加"会话"选项
    -   支持调整 Tab 位置顺序
    -   支持动态启用/禁用
-   **站点隔离**：每个站点的会话数据独立存储，互不干扰
-   **数据迁移**：兼容老用户，检测到本地存储无此 Tab 设置时自动添加并保存

---

### 2.2 对话列表展示

#### 数据来源

-   从页面左侧边栏（Sidebar）手动同步获取会话列表
-   支持**增量同步**：只添加新会话，不删除已有记录
-   支持**手动刷新**：右上角刷新按钮在会话 Tab 下执行“刷新会话列表”操作（非全量同步）

#### UI 布局：可展开分组式

```
┌──────────────────────────────────────────┐
│ 会话                      🔄  ➕  ⚙️    │  ← 🔄同步列表 ➕新建文件夹 ⚙️管理
├──────────────────────────────────────────┤
│ 🔍 搜索会话...                   标签🏷️   │  ← [BETA] 新增搜索框与标签筛选
├──────────────────────────────────────────┤
│ ▾ 📥 收件箱                    (12) ⋯   │  ← ⋯ 更多(重命名/删除/改图标)
│   ┌────────────────────────────────────┐ │
│   │ 会话标题A              12-18 10:13 │ │  ← 悬浮显示 [移动][删除][标签]
│   │ [工作] 会话标题B       12-17 14:22 │ │  ← 显示标签 badge
│   └────────────────────────────────────┘ │
│ ▾ 🎨 诗歌                       (5) ⋯   │
│   ┌────────────────────────────────────┐ │
│   │ ☑ 古诗词赏析           12-16 09:30 │ │  ← 勾选后可批量操作
│   │ ☐ 现代诗创作           12-15 16:45 │ │
│   └────────────────────────────────────┘ │
│ ▸ 💼 工作                       (8) ⋯   │  ← 折叠状态
│                                          │
│ • 已选 2 个会话 •  [移动] [删除]         │  ← 底部悬浮操作栏
└──────────────────────────────────────────┘
```

#### 交互功能

| 功能                | 交互设计                                       |
| ------------------- | ---------------------------------------------- |
| **文件夹展开/折叠** | 点击 ▾/▸ 箭头或文件夹名称                      |
| **文件夹多选**      | 点击文件夹复选框 → 自动勾选所有会话            |
| **会话单选**        | 点击会话项的复选框                             |
| **会话跳转**        | 点击会话标题 → 跳转到该会话页面                |
| **悬浮按钮**        | 鼠标悬停会话项 → 显示 `[🏷️标签] [移动] [删除]` |
| **批量操作**        | 底部悬浮栏显示"已选 X 个会话" + 移动/删除      |
| **搜索筛选**        | 顶部搜索框，实时过滤对话标题                   |

---

### 2.3 对话文件夹/分类

#### 分类结构

-   **单层文件夹**：MVP 阶段不支持嵌套，降低复杂度
-   **默认文件夹**：`📥 收件箱`，不可删除，可重命名
-   **用户自定义**：支持创建、重命名、删除、自定义图标（emoji）
-   **新会话归类**：自动归入**当前选中**或**上次使用**的文件夹

#### 文件夹操作

| 操作         | 触发方式      | 说明                           |
| ------------ | ------------- | ------------------------------ |
| **新建**     | 顶部 ➕ 按钮  | 弹出输入框，输入名称和选择图标 |
| **重命名**   | 文件夹 ⋯ 菜单 | 弹出编辑框                     |
| **删除**     | 文件夹 ⋯ 菜单 | 确认弹窗，会话移至默认文件夹   |
| **更改图标** | 文件夹 ⋯ 菜单 | Emoji 选择器                   |

---

### [NEW] 2.4 搜索与标签系统 (设计中)

#### 界面布局 (UI Layout)

-   **位置**：顶部工具栏下方，文件夹列表上方。
-   **搜索框**：左侧 85%，placeholder `🔍 搜索会话...`，支持实时过滤。
-   **标签筛选**：右侧 15%，图标按钮 `🏷️`，点击弹出标签多选下拉框。

#### 标签与视觉 (Visuals)

-   **标签展示**：在会话列表中，会话标题下方或右侧展示彩色标签 Badges（如 `[工作]` `[重要]`）。
-   **搜索交互**：输入关键词或选择标签后，自动展开包含匹配项的文件夹，并高亮匹配内容。

#### 操作流程 (Interaction)

-   **打标签**：会话右侧 `...` 菜单或悬浮按钮 -> `🏷️ 设置标签` -> 勾选或新建标签。
-   **批量打标签**（Phase 5+）：批量操作栏新增“标签”按钮。

#### 数据结构扩展

```javascript
// 全局标签定义
tags: [
  { id: 't1', name: '工作', color: '#e0f2fe' },
  { id: 't2', name: '待办', color: '#fef3c7' }
]

// 会话对象引用
conversations: {
  'c_123': {
    ...,
    tagIds: ['t1', 't2'] // 关联标签ID
  }
}
```

---

### 2.5 数据存储

-   使用 `GM_setValue` 持久化存储
-   **按站点隔离**：每个站点独立存储
-   存储结构示例：
    ```javascript
    // 存储 key: gemini_helper_conversations_${siteId}
    {
        "folders": [
            { "id": "inbox", "name": "📥 收件箱", "icon": "📥", "isDefault": true },
            { "id": "poetry", "name": "诗歌", "icon": "🎨", "isDefault": false }
        ],
        "tags": [],  // [NEW] 标签定义数组
        "conversations": {
            "conversation-id-1": {
                "title": "古诗词赏析",
                "folderId": "poetry",
                "tagIds": [],  // [NEW] 标签关联
                "updatedAt": 1734480000000
            }
        },
        "lastUsedFolderId": "poetry"
    }
    ```

---

## 6. 渐进式开发计划

> **原则**：每一步可追溯、可恢复、可验证，绝不破坏已有功能

### 6.1 阶段总览

| 阶段        | 内容                         | 状态 | Git Tag          |
| ----------- | ---------------------------- | ---- | ---------------- |
| **Phase 1** | Tab 骨架 + 空面板            | ✅   | `v1.9.0-conv-p1` |
| **Phase 2** | 数据存储 + 文件夹管理        | ✅   | `v1.9.0-conv-p2` |
| **Phase 3** | 会话同步 + 列表展示          | ✅   | `v1.9.0-conv-p3` |
| **Phase 4** | 交互功能（多选、移动、删除） | ✅   | `v1.9.0-conv-p4` |
| **Phase 5** | **搜索与标签系统 (NEW)**     | 📅   |                  |
| **Phase 6** | 设置集成 + 收尾              | ⬜   | `v1.9.0`         |

### 6.2 Phase 4：交互功能详情 (已完成)

-   [x] 复选框状态管理与全选/反选
-   [x] 移动到文件夹弹窗（包含搜索）
-   [x] 批量操作栏（移动、删除）
-   [x] 刷新按钮逻辑优化（列表刷新 vs 云端同步）

### 6.3 Phase 5：搜索与标签系统 (待开发)

**目标**：实现会话搜索、标签管理与筛选。

**任务分解**：

1.  **UI 升级**：添加搜索栏与标签筛选按钮。
2.  **数据层升级**：扩展 `ConversationManager` 支持 `tags` 和 `tagIds`。
3.  **交互实现**：
    -   会话搜索逻辑（本地过滤）
    -   标签管理（新建/编辑/删除）
    -   打标签（单条会话操作）
4.  **展示优化**：在列表中渲染标签 Badges。

---
